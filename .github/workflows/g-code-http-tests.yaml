name: HTTP G-Code Tests

on:
  # Run on any change to the api directory
  pull_request:
    paths:
      - 'api/**'
      - 'g-code-testing/**'
      - 'Makefile'
    branches:
      - '*'
  push:
    paths:
      - 'api/**'
      - 'g-code-testing/**'
      - 'Makefile'
    branches:
      - '*'

  workflow_dispatch:

jobs:
  http-g-code-tests:
    name: HTTP G-Code Tests
    runs-on: ubuntu-18.04
    steps:
      - name: Check out Monorepo
        uses: actions/checkout@v2

      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 12

      - name: Setup Python Environment
        uses: actions/setup-python@v2
        with:
          python-version: 3.7

      - name: Setup G-Code Testing Project
        uses: ./.github/actions/python/setup
        with:
          project: g-code-testing

      - name: Run HTTP call - Move Left Pipette
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_APP_DEPLOY_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_APP_DEPLOY_SECRET }}
          AWS_DEFAULT_REGION: us-east-2
        run: make -C g-code-testing g-code-http-move-left-pipette-diff

      - name: Save Generated Diff - Move Left Pipette
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: http-move-left-pipette-diff
          path: /tmp/http-move-left-pipette-diff.html

      - name: Run HTTP call - Move Right Pipette
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_APP_DEPLOY_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_APP_DEPLOY_SECRET }}
          AWS_DEFAULT_REGION: us-east-2
        run: make -C g-code-testing g-code-http-move-right-pipette-diff

      - name: Save Generated Diff - Move Right Pipette
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: http-move-right-pipette-diff
          path: /tmp/http-move-right-pipette-diff.html

      - name: Run HTTP call - Move Left Mount
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_APP_DEPLOY_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_APP_DEPLOY_SECRET }}
          AWS_DEFAULT_REGION: us-east-2
        run: make -C g-code-testing g-code-http-move-left-mount-diff

      - name: Save Generated Diff - Move Left Mount
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: http-move-left-mount-diff
          path: /tmp/http-move-left-mount-diff.html

      - name: Run HTTP call - Move Right Mount
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_APP_DEPLOY_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_APP_DEPLOY_SECRET }}
          AWS_DEFAULT_REGION: us-east-2
        run: make -C g-code-testing g-code-http-move-right-mount-diff

      - name: Save Generated Diff - Move Right Mount
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: http-move-right-mount-diff
          path: /tmp/http-move-right-mount-diff.html

      - name: Run HTTP call - Home Left Pipette
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_APP_DEPLOY_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_APP_DEPLOY_SECRET }}
          AWS_DEFAULT_REGION: us-east-2
        run: make -C g-code-testing g-code-http-home-left-pipette-diff

      - name: Save Generated Diff - Home Left Pipette
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: http-home-left-pipette-diff
          path: /tmp/http-home-left-pipette-diff.html

      - name: Run HTTP call - Home Right Pipette
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_APP_DEPLOY_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_APP_DEPLOY_SECRET }}
          AWS_DEFAULT_REGION: us-east-2
        run: make -C g-code-testing g-code-http-home-right-pipette-diff

      - name: Save Generated Diff - Home Right Pipette
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: http-home-right-pipette-diff
          path: /tmp/http-home-right-pipette-diff.html

      - name: Run HTTP call - Home Robot
        if: always()
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_APP_DEPLOY_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_APP_DEPLOY_SECRET }}
          AWS_DEFAULT_REGION: us-east-2
        run: make -C g-code-testing g-code-http-home-robot-diff

      - name: Save Generated Diff - Home Robot
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: http-home-robot-diff
          path: /tmp/http-home-robot-diff.html