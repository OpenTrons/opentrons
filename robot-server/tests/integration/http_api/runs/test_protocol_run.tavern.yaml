test_name: Upload and run a protocol.

marks:
  - usefixtures:
      - run_server
stages:
  - name: Upload simple, one comment protocol
    request:
      url: '{host:s}:{port:d}/protocols'
      method: POST
      files:
        files: 'tests/integration/protocols/simple.py'
    response:
      status_code: 201
      save:
        json:
          protocol_id: data.id

  - name: Create run from protocol
    request:
      url: '{host:s}:{port:d}/runs'
      method: POST
      json:
        data:
          protocolId: '{protocol_id}'
    response:
      status_code: 201
      json:
        data:
          id: !anystr
          createdAt: !re_search "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+\\+\\d{2}:\\d{2}$"
          status: idle
          current: True
          actions: []
          errors: []
          pipettes: []
          labware:
            - id: !anystr
              loadName: !anystr
              definitionUri: opentrons/opentrons_1_trash_1100ml_fixed/1
              location: !anydict
          labwareOffsets: []
          protocolId: '{protocol_id}'
      save:
        json:
          run_data: data
          run_id: data.id

  - name: Get the specific run we just created, by its ID
    request:
      url: '{host:s}:{port:d}/runs/{run_id}'
      method: GET
    response:
      status_code: 200
      json:
        # Check that `data` is identical to the original POSTed run.
        data: !force_format_include '{run_data}'

  - name: Get all runs and make sure our run is included
    request:
      url: '{host:s}:{port:d}/runs'
      method: GET
    response:
      strict:
        # The run_server fixture has session scope and is is reused across tests.
        # So, other tests may create their own runs that will show up here.
        # Ignore them.
        - json:off
      status_code: 200
      json:
        # Check that the `data` list contains at least one element that's
        # the original POSTed run.
        data:
          - !force_format_include '{run_data}'

  - name: Play the run
    request:
      url: '{host:s}:{port:d}/runs/{run_id}/actions'
      method: POST
      json:
        data:
          actionType: play
    response:
      status_code: 201
      json:
        data:
          id: !anystr
          actionType: play
          createdAt: !re_search "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+\\+\\d{2}:\\d{2}$"
      save:
        json:
          play_action_id: data.id

  - name: Get the run again and look for the play action we just created
    request:
      url: '{host:s}:{port:d}/runs/{run_id}'
      method: GET
    response:
      strict:
        - json:off
      status_code: 200
      json:
        data:
          actions:
            - id: '{play_action_id}'
              createdAt: !re_search "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+\\+\\d{2}:\\d{2}$"
              actionType: play
            # Other list items ignored because this stage disables strict checking.
          # Other keys ignored because this stage disables strict checking.

  - name: Wait for the protocol to complete
    max_retries: 10
    delay_after: 0.1
    request:
      url: '{host:s}:{port:d}/runs/{run_id}'
      method: GET
    response:
      strict:
        - json:off
      json:
        data:
          status: succeeded

  - name: Verify commands were run
    request:
      url: '{host:s}:{port:d}/runs/{run_id}/commands'
      method: GET
    response:
      json:
        links:
          current: !anydict
        meta:
          cursor: 0
          totalLength: 1
        data:
          - id: !anystr
            key: !anystr
            commandType: custom
            status: succeeded
            params:
              legacyCommandType: 'command.COMMENT'
              legacyCommandText: 'A single comment.'
            createdAt: !re_search "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+\\+\\d{2}:\\d{2}$"
            startedAt: !re_search "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+\\+\\d{2}:\\d{2}$"
            completedAt: !re_search "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d+\\+\\d{2}:\\d{2}$"

# todo(mm, 2022-05-17):
# - Test command details
# - Test that PATCH returns the same run, except with `current` set to false
# - POST some labware offsets, test that they show up in the run,
#   test that they show up in commands?
#   Maybe put this in a different file?
